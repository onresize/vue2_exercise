<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>preview</title>
</head>
<style>
  html,
  body {
    padding: 0;
    margin: 0;
  }

  .playWnd {
    /* margin: 30px 0 0 700px; */
    /* width: 600px;                   播放容器的宽和高设定 */
    /* height: 400px; */
    /* border: 1px solid red; */
    background: white;
  }

  .operate {
    margin-top: 24px;
  }

  .operate::after {
    content: '';
    display: block;
    clear: both;
  }

  .module {
    float: left;
    width: 340px;
    /*min-height: 320px;*/
    margin-left: 16px;
    padding: 16px 8px;
    box-sizing: border-box;
    border: 1px solid #e5e5e5;
  }

  .module .item {
    margin-bottom: 4px;
  }

  .module input[type="text"] {
    box-sizing: border-box;
    display: inline-block;
    vertical-align: middle;
    margin-left: 0;
    width: 150px;
    min-height: 20px;
  }

  .module .btn {
    min-width: 80px;
    min-height: 24px;
    margin-top: 100px;
    margin-left: 80px;
  }
</style>

<body>
  <!--回放界面-->
  <div id="operate" class="operate" style="display: none;">
    <div class="module">
      <div class="item"><span class="label">监控点编号：</span><input id="cameraIndexCode" type="text"
          value="36015608011320000317"></div>
      <div class="item" style="margin-top: 20px;margin-left: -20px;">
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <button style="width:90px;padding:0;margin:0;" id="startPreview" class="btn">预览</button>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <button style="width:90px;padding:0;margin:0;" id="stopAllPreview" class="btn">停止全部预览</button>
      </div>
    </div>
  </div>
  <!--视频窗口展示-->
  <div id="playWnd" class="playWnd"></div>
</body>

<!--三个必要的js文件引入-->
<script src="jquery-1.12.4.min.js"></script>
<script src="jsencrypt.min.js"></script>
<script src="jsWebControl-1.0.0.min.js"></script>

<script type="text/javascript">
  //页面加载时创建播放实例初始化

  // $(window).load(function () {
  //     // if(videoPlay && videoLoaded) {
  //     //   initPlugin();
  //     // } else {
  //       setTimeout(()=>{
  //         initPlugin();
  //       },1000)
  //     // }
        
  // });

  _width = 0;
  _height = 0;

  //声明公用变量
  var initCount = 0;
  var pubKey = '';
  var iLastCoverLeft = 0;
  var iLastCoverTop = 0;
  var iLastCoverRight = 0;
  var iLastCoverBottom = 0;
  var layout1 = '1x1'
  var closeCB = null
  // 创建WebControl实例与启动插件
  function initPlugin() {
    oWebControl = new WebControl({
      szPluginContainer: "playWnd", //指定容器id
      iServicePortStart: 15900, //指定起止端口号，建议使用该值
      iServicePortEnd: 15909,
      szClassId: "23BF3B0A-2C56-4D97-9C03-0CB103AA8F11", // 用于IE10使用ActiveX的clsid
      cbConnectSuccess: function () {
        setCallbacks(); //20200317
        //实例创建成功后需要启动服务
        oWebControl.JS_StartService("window", {
          dllPath: "./VideoPluginConnect.dll"
        }).then(function () {
          oWebControl.JS_CreateWnd("playWnd", _width, _height).then(function () { //JS_CreateWnd创建视频播放窗口，宽高可设定
            console.log("JS_CreateWnd success");
            init(); //创建播放实例成功后初始化
          });
        }, function () {

        });
      },
      cbConnectError: function () {
        console.log("cbConnectError");
        oWebControl = null;
        $("#playWnd").html("插件未启动，正在尝试启动，请稍候...");
        WebControl.JS_WakeUp("VideoWebPlugin://"); //程序未启动时执行error函数，采用wakeup来启动程序
        initCount++;
        if (initCount < 3) {
          setTimeout(function () {
            initPlugin();
          }, 3000)
        } else {
          $("#playWnd").html("插件启动失败，请检查插件是否安装！");
          var r = confirm("未检测到插件，是否下载插件!");
          if (r === true) {
            // var curWwwPath = window.parent.document.location.href.split('/#/')[0];
            // console.log(window.parent.document.location,'222')
            window.open( window.parent.document.location.origin +  '/demo/hk.exe')
          }
        }
      },
      cbConnectClose: function () {
        console.log("cbConnectClose");
        oWebControl = null;
      }
    });

  }

  // initPlugin();

  //初始化
  function init() {
    getPubKey(function () {

      ////////////////////////////////// 请自行修改以下变量值	////////////////////////////////////
      // var appkey = "27266782";                           //综合安防管理平台提供的appkey，必填
      // var appkey = "23730455"; //综合安防管理平台提供的appkey，必填 公安网
      // // var secret = setEncrypt("xSMAY3EGmme5Z7oSigov");   //综合安防管理平台提供的secret，必填 公安网
      // var secret = setEncrypt("pHcUQWQ1fGidyrlGgtrB"); //综合安防管理平台提供的secret，必填 公安网
      // var ip = "47.49.21.159"; //综合安防管理平台IP地址，必填 公安网
      var appkey = "22082343"; //综合安防管理平台提供的appkey，必填 公安网
      // var secret = setEncrypt("xSMAY3EGmme5Z7oSigov");   //综合安防管理平台提供的secret，必填 公安网
      var secret = setEncrypt("We2YOYuTJuWNrahk8NaR"); //综合安防管理平台提供的secret，必填 公安网
      var ip = "47.38.11.206"; //综合安防管理平台IP地址，必填 公安网

      var playMode = 0; //初始播放模式：0-预览，1-回放
      var port = 443; //综合安防管理平台端口，若启用HTTPS协议，默认443
      var snapDir = "D:\\SnapDir"; //抓图存储路径
      var videoDir = "D:\\VideoDir"; //紧急录像或录像剪辑存储路径
      var layout = layout1; //playMode指定模式的布局
      var enableHTTPS = 1; //是否启用HTTPS协议与综合安防管理平台交互，是为1，否为0
      var encryptedFields = 'secret'; //加密字段，默认加密领域为secret
      var showToolbar = 1; //是否显示工具栏，0-不显示，非0-显示
      var showSmart = 1; //是否显示智能信息（如配置移动侦测后画面上的线框），0-不显示，非0-显示
      var buttonIDs = "0,16,256,257,258,259,260,512,515,516,517,768,769"; //自定义工具条按钮
      ////////////////////////////////// 请自行修改以上变量值	////////////////////////////////////

      oWebControl.JS_RequestInterface({
        funcName: "init",
        argument: JSON.stringify({
          appkey: appkey, //API网关提供的appkey
          secret: secret, //API网关提供的secret
          ip: ip, //API网关IP地址
          playMode: playMode, //播放模式（决定显示预览还是回放界面）
          port: port, //端口
          snapDir: snapDir, //抓图存储路径
          videoDir: videoDir, //紧急录像或录像剪辑存储路径
          layout: layout, //布局
          enableHTTPS: enableHTTPS, //是否启用HTTPS协议
          encryptedFields: encryptedFields, //加密字段
          showToolbar: showToolbar, //是否显示工具栏
          showSmart: showSmart, //是否显示智能信息
          buttonIDs: buttonIDs //自定义工具条按钮
        })
      }).then(function (oData) {
        showCBInfo(JSON.stringify(oData ? oData.responseMsg : ''));
        // if (videoPlay) {
        //   console.log(videoPlay,'v1111')
        //   setTimeout(()=>{
        //     console.log(videoPlay,'v2222')
        //     videoPlay()
        //   }, 1000)
         
        // } else {
        //   console.log('v333')
          videoPlay();
        // }
        // if (videoLoaded != undefined) {
        videoLoaded();
      // }
        // oWebControl.JS_Resize(_width, _height);  // 初始化后resize一次，规避firefox下首次显示窗口后插件窗口未与DIV窗口重合问题
      });
    });
  }

  // 显示回调信息
  function showCBInfo(szInfo, type) {
    if (type === 'error') {
      szInfo = "<div style='color: red;'>" + dateFormat(new Date(), "yyyy-MM-dd hh:mm:ss") + " " + szInfo + "</div>";
    } else {
      szInfo = "<div>" + dateFormat(new Date(), "yyyy-MM-dd hh:mm:ss") + " " + szInfo + "</div>";
    }
    $("#cbInfo").html(szInfo + $("#cbInfo").html());
  }

  // 获取公钥
  function getPubKey(callback) {
    oWebControl.JS_RequestInterface({
      funcName: "getRSAPubKey",
      argument: JSON.stringify({
        keyLength: 1024
      })
    }).then(function (oData) {
      console.log(oData);
      if (oData.responseMsg.data) {
        pubKey = oData.responseMsg.data;
        callback()
      }
    })
  }

  // RSA加密
  function setEncrypt(value) {
    var encrypt = new JSEncrypt();
    encrypt.setPublicKey(pubKey);
    return encrypt.encrypt(value);
  }

  // 监听resize事件，使插件窗口尺寸跟随DIV窗口变化
  $(window).resize(function () {
    if (oWebControl != null) {
      oWebControl.JS_Resize(_width, _height);
      setWndCover();
    }
  });

  // 监听滚动条scroll事件，使插件窗口跟随浏览器滚动而移动
  $(window).scroll(function () {
    if (oWebControl != null) {
      oWebControl.JS_Resize(_width, _height);
      setWndCover();
    }
  });


  // 设置窗口裁剪，当因滚动条滚动导致窗口需要被遮住的情况下需要JS_CuttingPartWindow部分窗口
  function setWndCover() {
    return
    var iWidth = $(window).width();
    var iHeight = $(window).height();
    var oDivRect = $("#playWnd").get(0).getBoundingClientRect();

    var iCoverLeft = (oDivRect.left < 0) ? Math.abs(oDivRect.left) : 0;
    var iCoverTop = (oDivRect.top < 0) ? Math.abs(oDivRect.top) : 0;
    var iCoverRight = (oDivRect.right - iWidth > 0) ? Math.round(oDivRect.right - iWidth) : 0;
    var iCoverBottom = (oDivRect.bottom - iHeight > 0) ? Math.round(oDivRect.bottom - iHeight) : 0;

    iCoverLeft = (iCoverLeft > _width) ? _width : iCoverLeft;
    iCoverTop = (iCoverTop > _height) ? _height : iCoverTop;
    iCoverRight = (iCoverRight > _width) ? _width : iCoverRight;
    iCoverBottom = (iCoverBottom > _height) ? _height : iCoverBottom;

    if (iLastCoverLeft != iCoverLeft) {
      console.log("iCoverLeft: " + iCoverLeft);
      iLastCoverLeft = iCoverLeft;
      oWebControl.JS_SetWndCover("left", iCoverLeft);
    }
    if (iLastCoverTop != iCoverTop) {
      console.log("iCoverTop: " + iCoverTop);
      iLastCoverTop = iCoverTop;
      oWebControl.JS_SetWndCover("top", iCoverTop);
    }
    if (iLastCoverRight != iCoverRight) {
      console.log("iCoverRight: " + iCoverRight);
      iLastCoverRight = iCoverRight;
      oWebControl.JS_SetWndCover("right", iCoverRight);
    }
    if (iLastCoverBottom != iCoverBottom) {
      console.log("iCoverBottom: " + iCoverBottom);
      iLastCoverBottom = iCoverBottom;
      oWebControl.JS_SetWndCover("bottom", iCoverBottom);
    }
  }


  //录像回放功能
  $("#startPreview").click(function () {

    var cameraIndexCode = $("#cameraIndexCode").val(); //获取输入的监控点编号值，必填
    var streamMode = 0; //主子码流标识：0-主码流，1-子码流
    var recordLocation = 0; //录像存储位置：0-中心存储，1-设备存储
    var transMode = 1; //传输协议：0-UDP，1-TCP
    var gpuMode = 0; //是否启用GPU硬解，0-不启用，1-启用
    var wndId = -1; //播放窗口序号（在2x2以上布局下可指定播放窗口）

    oWebControl.JS_RequestInterface({
      funcName: "startPreview",
      argument: JSON.stringify({
        cameraIndexCode: cameraIndexCode, //监控点编号
        streamMode: streamMode, //主子码流标识
        recordLocation: recordLocation, //录像存储类型：0-中心存储，1-设备存储
        transMode: transMode, //传输协议：0-UDP，1-TCP
        gpuMode: gpuMode, //是否启用GPU硬解，0-不启用，1-启用
        wndId: wndId //可指定播放窗口
      })
    })
  });



  //视频预览调用
  function startPreview(params) {
    if (params.cameraIndexCode == '') {
      alert("编号不能为空")
      return;
    }
    var cameraIndexCode = params.cameraIndexCode; //获取输入的监控点编号值，必填
    var streamMode = 0; //主子码流标识：0-主码流，1-子码流
    var recordLocation = 0; //录像存储位置：0-中心存储，1-设备存储
    var transMode = 1; //传输协议：0-UDP，1-TCP
    var gpuMode = 0; //是否启用GPU硬解，0-不启用，1-启用
    var wndId = params.wind || -1;

    oWebControl.JS_RequestInterface({
      funcName: "startPreview",
      argument: JSON.stringify({
        cameraIndexCode: cameraIndexCode, //监控点编号
        streamMode: streamMode, //主子码流标识
        recordLocation: recordLocation, //录像存储类型：0-中心存储，1-设备存储
        transMode: transMode, //传输协议：0-UDP，1-TCP
        gpuMode: 1, //是否启用GPU硬解，0-不启用，1-启用
        wndId: wndId //可指定播放窗口
      })
    }).then(()=>{
      // if (videoLoaded != undefined) {
      //   videoLoaded();
      // }
    })
  }


  // 设置窗口控制回调
  function setCallbacks() {
    oWebControl.JS_SetWindowControlCallback({
      cbIntegrationCallBack: cbIntegrationCallBack
    });
  }

  // 推送消息
  function cbIntegrationCallBack(oData) {
    showCBInfo(JSON.stringify(oData.responseMsg));
  }

  // 停止回放
  $("#stopAllPreview").click(function () {
    oWebControl.JS_RequestInterface({
      funcName: "stopAllPreview"
    }).then(()=>{
      if (closeCB) {
        closeCB()
      }
      console.log('stopAllPreview')
    })
  });

  function doStopAllPreview() {
    oWebControl.JS_RequestInterface({
      funcName: "stopAllPreview"
    }).then(function (oData) {
      console.log('stopAllPreviewsucc')
      
      if (closeCB) {
        closeCB()
      }
      doDestroy()
      // showCBInfo(JSON.stringify(oData ? oData.responseMsg : ''));
    });
  }

  // 格式化时间
  function dateFormat(oDate, fmt) {
    var o = {
      "M+": oDate.getMonth() + 1, //月份
      "d+": oDate.getDate(), //日
      "h+": oDate.getHours(), //小时
      "m+": oDate.getMinutes(), //分
      "s+": oDate.getSeconds(), //秒
      "q+": Math.floor((oDate.getMonth() + 3) / 3), //季度
      "S": oDate.getMilliseconds() //毫秒
    };
    if (/(y+)/.test(fmt)) {
      fmt = fmt.replace(RegExp.$1, (oDate.getFullYear() + "").substr(4 - RegExp.$1.length));
    }
    for (var k in o) {
      if (new RegExp("(" + k + ")").test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
      }
    }
    return fmt;
  }

  // 标签关闭
  $(window).unload(function () {
    if (oWebControl != null) {
      oWebControl.JS_HideWnd(); // 先让窗口隐藏，规避插件窗口滞后于浏览器消失问题
      oWebControl.JS_Disconnect().then(function () {}, function () {});
    }
  });

  function doChangeSize(style, w, h) {
    _width = w
    _height = h
    console.log(style,'ssss--')
    $('#playWnd').css(style);
    if (oWebControl != null) {
      oWebControl.JS_Resize(_width, _height);
      setWndCover();
    }
  }

  // if (videoLoaded != undefined) {
  //   videoLoaded();
  // }

  // 销毁组件
  function doDestroy() {
    oWebControl.JS_RequestInterface({
      funcName: "destroyWnd"
    }).then(function (oData) {
      console.log('插件已销毁!')
 
      showCBInfo(JSON.stringify(oData ? oData.responseMsg : ''));
    });
  }
</script>

</html>